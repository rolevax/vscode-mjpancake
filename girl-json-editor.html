<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        img#preview {
            min-width: 300px;
            min-height: 500px;
            max-width: 300px;
            max-height: 500px;
        }
    </style>
</head>
<body>
    <center>
        <a id="fuck"></a>
        <form id="form">
            <table>
                <tr>
                    <td>Name</td>
                    <td><input type="text" name="name" /></td>
                </tr>
                <tr>
                    <td>Photo File</td>
                    <td><input type="file" name="photo" accept="image/png, image/jpeg"></td>
                </tr>
                <tr>
                    <td>Photo Preview</td>
                    <td><img id="preview"></img></td>
                </tr>
                <tr>
                    <td rowspan=3>Actions</td>
                    <td><button id="buttonSave">Save</button></td>
                </tr>
                    <td><button>3 Doge Match</button></td>
                </tr>
                </tr>
                    <td><button>Export to Pancake</button></td>
                </tr>
            </table>
        </form>
    </center>

    <script>
        const fuck = document.getElementById("fuck"); // for debug use
        const form = document.getElementById("form");
        const preview = document.getElementById("preview");
        const buttonSave = document.getElementById("buttonSave");
        const vscode = acquireVsCodeApi();

        let girlJson = { name: "", photoBase64: "" };
        const refreshDisplay = () => {
            form.name.value = girlJson.name;
            if (girlJson.photoBase64) {
                preview.src = "data:image/png;base64," + girlJson.photoBase64;
            } else {
                preview.src = undefined;
            }
        }

        const savedState = vscode.getState();
        if (savedState) {
            girlJson = savedState;
            refreshDisplay();
        }

        window.addEventListener('message', event => {
            girlJson = event.data;
            if (!girlJson.name) {
                girlJson.name = "";
            }
            if (!girlJson.photoBase64) {
                girlJson.photoBase64 = "";
            }
            vscode.setState(girlJson);
            refreshDisplay();
        });

        form.name.addEventListener('input', event => {
            girlJson.name = form.name.value;
            vscode.setState(girlJson);
        });

        form.photo.addEventListener('change', event => {
            if (form.photo.files.length > 0) {
                let image = form.photo.files[0];
                preview.src = window.URL.createObjectURL(image);
            }
        });

        preview.onload = () => {
            let canvas = document.createElement("canvas");
            canvas.width = preview.width;
            canvas.height = preview.height;
            canvas.getContext("2d").drawImage(preview, 0, 0, preview.width, preview.height);
            girlJson.photoBase64 = canvas.toDataURL().split(",")[1];
            vscode.setState(girlJson);
        };

        buttonSave.onclick = () => {
            vscode.postMessage(girlJson);
        };
    </script>
</body>
</html>